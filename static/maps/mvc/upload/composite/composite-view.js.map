{"version":3,"sources":["mvc/upload/composite/composite-view.js"],"names":["Backbone","View","extend","collection","Collection","initialize","app","self","options","list_extensions","list_genomes","ftp_upload_site","currentFtp","setElement","_template","btnStart","Button","title","onclick","_eventStart","btnClose","modal","hide","_","each","$","prepend","button","$el","select_extension","css","container","data","filter","ext","composite_files","onchange","extension","reset","details","findWhere","id","add","size","file_desc","item","description","name","on","e","target","text","value","list","placement","preventDefault","select_genome","default_genome","listenTo","_eventAnnounce","model","render","first","get","disable","enable","where","status","length","addClass","removeClass","upload_row","append","set","genome","uploadpost","url","nginx_upload_path","toData","success","message","_eventSuccess","error","_eventError","progress","percentage","_eventProgress","it","Galaxy","currHistoryPanel","refreshContents","info"],"mappings":"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","file":"../../../../scripts/mvc/upload/composite/composite-view.js","sourcesContent":["import _l from \"utils/localization\";\n/** Renders contents of the composite uploader */\nimport Utils from \"utils/utils\";\nimport UploadModel from \"mvc/upload/upload-model\";\nimport UploadRow from \"mvc/upload/composite/composite-row\";\nimport UploadExtension from \"mvc/upload/upload-extension\";\nimport Popover from \"mvc/ui/ui-popover\";\nimport Select from \"mvc/ui/ui-select\";\nimport Ui from \"mvc/ui/ui-misc\";\nexport default Backbone.View.extend({\n    collection: new UploadModel.Collection(),\n    initialize: function(app) {\n        var self = this;\n        this.app = app;\n        this.options = app.options;\n        this.list_extensions = app.list_extensions;\n        this.list_genomes = app.list_genomes;\n        this.ftp_upload_site = app.currentFtp();\n        this.setElement(this._template());\n\n        // create button section\n        this.btnStart = new Ui.Button({\n            title: _l(\"Start\"),\n            onclick: function() {\n                self._eventStart();\n            }\n        });\n        this.btnClose = new Ui.Button({\n            title: _l(\"Close\"),\n            onclick: function() {\n                self.app.modal.hide();\n            }\n        });\n\n        // append buttons to dom\n        _.each([this.btnStart, this.btnClose], button => {\n            self.$(\".upload-buttons\").prepend(button.$el);\n        });\n\n        // select extension\n        this.select_extension = new Select.View({\n            css: \"upload-footer-selection\",\n            container: this.$(\".upload-footer-extension\"),\n            data: _.filter(this.list_extensions, ext => ext.composite_files),\n            onchange: function(extension) {\n                self.collection.reset();\n                var details = _.findWhere(self.list_extensions, {\n                    id: extension\n                });\n                if (details && details.composite_files) {\n                    _.each(details.composite_files, item => {\n                        self.collection.add({\n                            id: self.collection.size(),\n                            file_desc: item.description || item.name\n                        });\n                    });\n                }\n            }\n        });\n\n        // handle extension info popover\n        this.$(\".upload-footer-extension-info\")\n            .on(\"click\", e => {\n                new UploadExtension({\n                    $el: $(e.target),\n                    title: self.select_extension.text(),\n                    extension: self.select_extension.value(),\n                    list: self.list_extensions,\n                    placement: \"top\"\n                });\n            })\n            .on(\"mousedown\", e => {\n                e.preventDefault();\n            });\n\n        // genome extension\n        this.select_genome = new Select.View({\n            css: \"upload-footer-selection\",\n            container: this.$(\".upload-footer-genome\"),\n            data: this.list_genomes,\n            value: this.options.default_genome\n        });\n\n        // listener for collection triggers on change in composite datatype and extension selection\n        this.listenTo(this.collection, \"add\", model => {\n            self._eventAnnounce(model);\n        });\n        this.listenTo(this.collection, \"change add\", () => {\n            self.render();\n        });\n        this.select_extension.options.onchange(this.select_extension.value());\n        this.render();\n    },\n\n    render: function() {\n        var model = this.collection.first();\n        if (model && model.get(\"status\") == \"running\") {\n            this.select_genome.disable();\n            this.select_extension.disable();\n        } else {\n            this.select_genome.enable();\n            this.select_extension.enable();\n        }\n        if (this.collection.where({ status: \"ready\" }).length == this.collection.length && this.collection.length > 0) {\n            this.btnStart.enable();\n            this.btnStart.$el.addClass(\"btn-primary\");\n        } else {\n            this.btnStart.disable();\n            this.btnStart.$el.removeClass(\"btn-primary\");\n        }\n        this.$(\".upload-table\")[this.collection.length > 0 ? \"show\" : \"hide\"]();\n    },\n\n    //\n    // upload events / process pipeline\n    //\n\n    /** Builds the basic ui with placeholder rows for each composite data type file */\n    _eventAnnounce: function(model) {\n        var upload_row = new UploadRow(this, { model: model });\n        this.$(\".upload-table > tbody:first\").append(upload_row.$el);\n        this.$(\".upload-table\")[this.collection.length > 0 ? \"show\" : \"hide\"]();\n        upload_row.render();\n    },\n\n    /** Start upload process */\n    _eventStart: function() {\n        var self = this;\n        this.collection.each(model => {\n            model.set({\n                genome: self.select_genome.value(),\n                extension: self.select_extension.value()\n            });\n        });\n        $.uploadpost({\n            url: this.app.options.nginx_upload_path,\n            data: this.app.toData(this.collection.filter()),\n            success: function(message) {\n                self._eventSuccess(message);\n            },\n            error: function(message) {\n                self._eventError(message);\n            },\n            progress: function(percentage) {\n                self._eventProgress(percentage);\n            }\n        });\n    },\n\n    /** Refresh progress state */\n    _eventProgress: function(percentage) {\n        this.collection.each(it => {\n            it.set(\"percentage\", percentage);\n        });\n    },\n\n    /** Refresh success state */\n    _eventSuccess: function(message) {\n        this.collection.each(it => {\n            it.set(\"status\", \"success\");\n        });\n        Galaxy.currHistoryPanel.refreshContents();\n    },\n\n    /** Refresh error state */\n    _eventError: function(message) {\n        this.collection.each(it => {\n            it.set({ status: \"error\", info: message });\n        });\n    },\n\n    /** Load html template */\n    _template: function() {\n        return (\n            '<div class=\"upload-view-composite\">' +\n            '<div class=\"upload-top\">' +\n            '<h6 class=\"upload-top-info\"/>' +\n            \"</div>\" +\n            '<div class=\"upload-box\">' +\n            '<table class=\"upload-table ui-table-striped\" style=\"display: none;\">' +\n            \"<thead>\" +\n            \"<tr>\" +\n            \"<th/>\" +\n            \"<th/>\" +\n            \"<th>Description</th>\" +\n            \"<th>Name</th>\" +\n            \"<th>Size</th>\" +\n            \"<th>Settings</th>\" +\n            \"<th>Status</th>\" +\n            \"</tr>\" +\n            \"</thead>\" +\n            \"<tbody/>\" +\n            \"</table>\" +\n            \"</div>\" +\n            '<div class=\"upload-footer\">' +\n            '<span class=\"upload-footer-title\">Composite Type:</span>' +\n            '<span class=\"upload-footer-extension\"/>' +\n            '<span class=\"upload-footer-extension-info upload-icon-button fa fa-search\"/> ' +\n            '<span class=\"upload-footer-title\">Genome/Build:</span>' +\n            '<span class=\"upload-footer-genome\"/>' +\n            \"</div>\" +\n            '<div class=\"upload-buttons\"/>' +\n            \"</div>\"\n        );\n    }\n});\n"]}