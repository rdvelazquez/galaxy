{"version":3,"sources":["mvc/history/history-view-edit.js"],"names":["_super","HistoryView","HistoryViewEdit","extend","HDAViewClass","HDAListItemEdit","HDCAViewClass","HDCAListItemEdit","initialize","attributes","prototype","call","tagsEditor","dragItems","annotationEditor","purgeAllowed","annotationEditorShown","tagsEditorShown","_setUpListeners","on","ev","data","dataDropped","dropTargetOff","_renderCounts","_renderSearchProgress","_renderSearchFindings","_setUpModelListeners","listenTo","model","updateHistoryDiskSize","_setUpCollectionListeners","collection","_handleItemDeletedChange","_handleItemVisibleChange","fetch","$","html","_buildNewRender","$newRender","Galaxy","user","id","get","_renderTags","_renderAnnotation","text","renderItems","$whereTo","views","searchFor","jQuery","$el","templates","counts","toJSON","find","$where","panel","TagsEditor","el","onshowFirstTime","render","onshow","toggleHDATagEditors","fxSpeed","onhide","$activator","title","classes","faIcon","appendTo","AnnotationEditor","toggleHDAAnnotationEditors","_setUpBehaviors","isAnonymous","nameSelector","attr","tooltip","placement","make_text_editable","on_finish","newName","previousName","save","name","fail","previous","multiselectActions","actions","func","action","HistoryDatasetAssociation","hide","getSelectedModels","ajaxQueue","unhide","undelete","push","confirm","purge","historyContents","selectedDatasets","filter","c","concat","_collectionActions","buildCollection","collectionType","selection","hideSourceItems","createFunc","createListCollection","createPairCollection","createListOfPairsCollection","console","warn","done","refresh","_getItemViewOptions","options","_","hidden","itemModel","_handleItemDeletion","_handleItemUndeletion","contentsShown","deleted","active","contents","includeDeleted","removeItemView","set","_handleItemHidden","_handleItemUnhidden","includeHidden","showOrHide","speed","each","view","toggle","events","clone","toggleShowDeleted","toggleShowHidden","limit","offset","stop","join","found","dropTargetOn","dropTarget","dropHandlers","dragenter","bind","dragover","dragleave","drop","$dropTarget","_renderDropTarget","$list","before","_renderDropTargetHelp","evName","hasOwnProperty","remove","addClass","_dropHandlers","off","dropTargetToggle","preventDefault","stopPropagation","css","self","dataTransfer","originalEvent","getData","dropEffect","JSON","parse","err","trigger","isObject","model_class","currentPage","fetchPage","then","copy","when","toString","countsTemplate","wrapTemplate","foundTemplate"],"mappings":"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","file":"../../../scripts/mvc/history/history-view-edit.js","sourcesContent":["import HISTORY_VIEW from \"mvc/history/history-view\";\nimport HISTORY_CONTENTS from \"mvc/history/history-contents\";\nimport STATES from \"mvc/dataset/states\";\nimport HDA_MODEL from \"mvc/history/hda-model\";\nimport HDA_LI_EDIT from \"mvc/history/hda-li-edit\";\nimport HDCA_LI_EDIT from \"mvc/history/hdca-li-edit\";\nimport TAGS from \"mvc/tag\";\nimport ANNOTATIONS from \"mvc/annotation\";\nimport LIST_COLLECTION_CREATOR from \"mvc/collection/list-collection-creator\";\nimport PAIR_COLLECTION_CREATOR from \"mvc/collection/pair-collection-creator\";\nimport LIST_OF_PAIRS_COLLECTION_CREATOR from \"mvc/collection/list-of-pairs-collection-creator\";\nimport faIconButton from \"ui/fa-icon-button\";\nimport PopupMenu from \"mvc/ui/popup-menu\";\nimport BASE_MVC from \"mvc/base-mvc\";\nimport _l from \"utils/localization\";\nimport \"ui/editable-text\";\n\n/* =============================================================================\nTODO:\n\n============================================================================= */\nvar _super = HISTORY_VIEW.HistoryView;\n// base class for history-view-edit-current and used as-is in history/view.mako\n/** @class Editable View/Controller for the history model.\n *\n *  Allows:\n *      (everything HistoryView allows)\n *      changing the name\n *      displaying and editing tags and annotations\n *      multi-selection and operations on mulitple content items\n */\nvar HistoryViewEdit = _super.extend(\n    /** @lends HistoryViewEdit.prototype */ {\n        /** class to use for constructing the HistoryDatasetAssociation views */\n        HDAViewClass: HDA_LI_EDIT.HDAListItemEdit,\n        /** class to use for constructing the HistoryDatasetCollectionAssociation views */\n        HDCAViewClass: HDCA_LI_EDIT.HDCAListItemEdit,\n\n        // ......................................................................... SET UP\n        /** Set up the view, set up storage, bind listeners to HistoryContents events\n         *  @param {Object} attributes\n         */\n        initialize: function(attributes) {\n            attributes = attributes || {};\n            _super.prototype.initialize.call(this, attributes);\n\n            // ---- set up instance vars\n            /** editor for tags - sub-view */\n            this.tagsEditor = null;\n\n            /** enable drag and drop - sub-view */\n            this.dragItems = true;\n\n            /** editor for annotations - sub-view */\n            this.annotationEditor = null;\n\n            /** allow user purge of dataset files? */\n            this.purgeAllowed = attributes.purgeAllowed || false;\n\n            // states/modes the panel can be in\n            /** is the panel currently showing the dataset selection controls? */\n            this.annotationEditorShown = attributes.annotationEditorShown || false;\n            this.tagsEditorShown = attributes.tagsEditorShown || false;\n        },\n\n        /** Override to handle history as drag-drop target */\n        _setUpListeners: function() {\n            _super.prototype._setUpListeners.call(this);\n            return this.on({\n                \"droptarget:drop\": function(ev, data) {\n                    // process whatever was dropped and re-hide the drop target\n                    this.dataDropped(data);\n                    this.dropTargetOff();\n                },\n                \"view:attached view:removed\": function() {\n                    this._renderCounts();\n                },\n                \"search:loading-progress\": this._renderSearchProgress,\n                \"search:searching\": this._renderSearchFindings\n            });\n        },\n\n        // ------------------------------------------------------------------------ listeners\n        /** listening for history and HDA events */\n        _setUpModelListeners: function() {\n            _super.prototype._setUpModelListeners.call(this);\n            this.listenTo(this.model, \"change:size\", this.updateHistoryDiskSize);\n            return this;\n        },\n\n        /** listening for collection events */\n        _setUpCollectionListeners: function() {\n            _super.prototype._setUpCollectionListeners.call(this);\n            this.listenTo(this.collection, {\n                \"change:deleted\": this._handleItemDeletedChange,\n                \"change:visible\": this._handleItemVisibleChange,\n                \"change:purged\": function(model) {\n                    // hafta get the new nice-size w/o the purged model\n                    this.model.fetch();\n                },\n                // loading indicators for deleted/hidden\n                \"fetching-deleted\": function(collection) {\n                    this.$(\"> .controls .deleted-count\").html(`<i>${_l(\"loading...\")}</i>`);\n                },\n                \"fetching-hidden\": function(collection) {\n                    this.$(\"> .controls .hidden-count\").html(`<i>${_l(\"loading...\")}</i>`);\n                },\n                \"fetching-deleted-done fetching-hidden-done\": this._renderCounts\n            });\n            return this;\n        },\n\n        // ------------------------------------------------------------------------ panel rendering\n        /** In this override, add tag and annotation editors and a btn to toggle the selectors */\n        _buildNewRender: function() {\n            // create a new render using a skeleton template, render title buttons, render body, and set up events, etc.\n            var $newRender = _super.prototype._buildNewRender.call(this);\n            if (!this.model) {\n                return $newRender;\n            }\n\n            if (Galaxy && Galaxy.user && Galaxy.user.id && Galaxy.user.id === this.model.get(\"user_id\")) {\n                this._renderTags($newRender);\n                this._renderAnnotation($newRender);\n            }\n            return $newRender;\n        },\n\n        /** Update the history size display (curr. upper right of panel). */\n        updateHistoryDiskSize: function() {\n            this.$(\".history-size\").text(this.model.get(\"nice_size\"));\n        },\n\n        /** override to render counts when the items are rendered */\n        renderItems: function($whereTo) {\n            var views = _super.prototype.renderItems.call(this, $whereTo);\n            if (!this.searchFor) {\n                this._renderCounts($whereTo);\n            } else {\n                this._renderSearchFindings($whereTo);\n            }\n            return views;\n        },\n\n        /** override to show counts, what's deleted/hidden, and links to toggle those */\n        _renderCounts: function($whereTo) {\n            $whereTo = $whereTo instanceof jQuery ? $whereTo : this.$el;\n            var html = this.templates.counts(this.model.toJSON(), this);\n            return $whereTo.find(\"> .controls .subtitle\").html(html);\n        },\n\n        /** render the tags sub-view controller */\n        _renderTags: function($where) {\n            var panel = this;\n            this.tagsEditor = new TAGS.TagsEditor({\n                model: this.model,\n                el: $where.find(\".controls .tags-display\"),\n                onshowFirstTime: function() {\n                    this.render();\n                },\n                // show hide sub-view tag editors when this is shown/hidden\n                onshow: function() {\n                    panel.toggleHDATagEditors(true, panel.fxSpeed);\n                },\n                onhide: function() {\n                    panel.toggleHDATagEditors(false, panel.fxSpeed);\n                },\n                $activator: faIconButton({\n                    title: _l(\"Edit history tags\"),\n                    classes: \"history-tag-btn\",\n                    faIcon: \"fa-tags\"\n                }).appendTo($where.find(\".controls .actions\"))\n            });\n        },\n        /** render the annotation sub-view controller */\n        _renderAnnotation: function($where) {\n            var panel = this;\n            this.annotationEditor = new ANNOTATIONS.AnnotationEditor({\n                model: this.model,\n                el: $where.find(\".controls .annotation-display\"),\n                onshowFirstTime: function() {\n                    this.render();\n                },\n                // show hide sub-view view annotation editors when this is shown/hidden\n                onshow: function() {\n                    panel.toggleHDAAnnotationEditors(true, panel.fxSpeed);\n                },\n                onhide: function() {\n                    panel.toggleHDAAnnotationEditors(false, panel.fxSpeed);\n                },\n                $activator: faIconButton({\n                    title: _l(\"Edit history annotation\"),\n                    classes: \"history-annotate-btn\",\n                    faIcon: \"fa-comment\"\n                }).appendTo($where.find(\".controls .actions\"))\n            });\n        },\n\n        /** Set up HistoryViewEdit js/widget behaviours\n         *  In this override, make the name editable\n         */\n        _setUpBehaviors: function($where) {\n            $where = $where || this.$el;\n            _super.prototype._setUpBehaviors.call(this, $where);\n            if (!this.model) {\n                return;\n            }\n\n            // anon users shouldn't have access to any of the following\n            if (!Galaxy.user || Galaxy.user.isAnonymous() || Galaxy.user.id !== this.model.get(\"user_id\")) {\n                return;\n            }\n\n            var panel = this;\n            var nameSelector = \"> .controls .name\";\n            $where\n                .find(nameSelector)\n                .attr(\"title\", _l(\"Click to rename history\"))\n                .tooltip({ placement: \"bottom\" })\n                .make_text_editable({\n                    on_finish: function(newName) {\n                        var previousName = panel.model.get(\"name\");\n                        if (newName && newName !== previousName) {\n                            panel.$el.find(nameSelector).text(newName);\n                            panel.model.save({ name: newName }).fail(() => {\n                                panel.$el.find(nameSelector).text(panel.model.previous(\"name\"));\n                            });\n                        } else {\n                            panel.$el.find(nameSelector).text(previousName);\n                        }\n                    }\n                });\n        },\n\n        /** return a new popup menu for choosing a multi selection action\n         *  ajax calls made for multiple datasets are queued\n         */\n        multiselectActions: function() {\n            var panel = this;\n\n            var actions = [\n                {\n                    html: _l(\"Hide datasets\"),\n                    func: function() {\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.hide;\n                        panel.getSelectedModels().ajaxQueue(action);\n                    }\n                },\n                {\n                    html: _l(\"Unhide datasets\"),\n                    func: function() {\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.unhide;\n                        panel.getSelectedModels().ajaxQueue(action);\n                    }\n                },\n                {\n                    html: _l(\"Delete datasets\"),\n                    func: function() {\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype[\"delete\"];\n                        panel.getSelectedModels().ajaxQueue(action);\n                    }\n                },\n                {\n                    html: _l(\"Undelete datasets\"),\n                    func: function() {\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.undelete;\n                        panel.getSelectedModels().ajaxQueue(action);\n                    }\n                }\n            ];\n\n            if (panel.purgeAllowed) {\n                actions.push({\n                    html: _l(\"Permanently delete datasets\"),\n                    func: function() {\n                        if (confirm(_l(\"This will permanently remove the data in your datasets. Are you sure?\"))) {\n                            var action = HDA_MODEL.HistoryDatasetAssociation.prototype.purge;\n                            const historyContents = panel.getSelectedModels();\n                            const selectedDatasets = historyContents.filter(\n                                c =>\n                                    c.get(\"history_content_type\") == \"dataset\"\n                            )\n                            historyContents.ajaxQueue(action, {}, selectedDatasets);\n                        }\n                    }\n                });\n            }\n            actions = actions.concat(panel._collectionActions());\n            return actions;\n        },\n\n        /**   */\n        _collectionActions: function() {\n            var panel = this;\n            return [\n                {\n                    html: _l(\"Build Dataset List\"),\n                    func: function() {\n                        panel.buildCollection(\"list\");\n                    }\n                },\n                // TODO: Only show quick pair if two things selected.\n                {\n                    html: _l(\"Build Dataset Pair\"),\n                    func: function() {\n                        panel.buildCollection(\"paired\");\n                    }\n                },\n                {\n                    html: _l(\"Build List of Dataset Pairs\"),\n                    func: function() {\n                        panel.buildCollection(\"list:paired\");\n                    }\n                }\n            ];\n        },\n\n        buildCollection: function(collectionType, selection, hideSourceItems) {\n            var panel = this;\n            var selection = selection || panel.getSelectedModels();\n            var hideSourceItems = hideSourceItems || false;\n            var createFunc;\n            if (collectionType == \"list\") {\n                createFunc = LIST_COLLECTION_CREATOR.createListCollection;\n            } else if (collectionType == \"paired\") {\n                createFunc = PAIR_COLLECTION_CREATOR.createPairCollection;\n            } else if (collectionType == \"list:paired\") {\n                createFunc = LIST_OF_PAIRS_COLLECTION_CREATOR.createListOfPairsCollection;\n            } else {\n                console.warn(`Unknown collectionType encountered ${collectionType}`);\n            }\n            createFunc(selection, hideSourceItems).done(() => {\n                panel.model.refresh();\n            });\n        },\n\n        // ------------------------------------------------------------------------ sub-views\n        /** In this override, add purgeAllowed and whether tags/annotation editors should be shown */\n        _getItemViewOptions: function(model) {\n            var options = _super.prototype._getItemViewOptions.call(this, model);\n            _.extend(options, {\n                purgeAllowed: this.purgeAllowed,\n                tagsEditorShown: this.tagsEditor && !this.tagsEditor.hidden,\n                annotationEditorShown: this.annotationEditor && !this.annotationEditor.hidden\n            });\n            return options;\n        },\n\n        /** If this item is deleted and we're not showing deleted items, remove the view\n         *  @param {Model} the item model to check\n         */\n        _handleItemDeletedChange: function(itemModel) {\n            if (itemModel.get(\"deleted\")) {\n                this._handleItemDeletion(itemModel);\n            } else {\n                this._handleItemUndeletion(itemModel);\n            }\n            this._renderCounts();\n        },\n\n        _handleItemDeletion: function(itemModel) {\n            var contentsShown = this.model.get(\"contents_active\");\n            contentsShown.deleted += 1;\n            contentsShown.active -= 1;\n            if (!this.model.contents.includeDeleted) {\n                this.removeItemView(itemModel);\n            }\n            this.model.set(\"contents_active\", contentsShown);\n        },\n\n        _handleItemUndeletion: function(itemModel) {\n            var contentsShown = this.model.get(\"contents_active\");\n            contentsShown.deleted -= 1;\n            if (!this.model.contents.includeDeleted) {\n                contentsShown.active -= 1;\n            }\n            this.model.set(\"contents_active\", contentsShown);\n        },\n\n        /** If this item is hidden and we're not showing hidden items, remove the view\n         *  @param {Model} the item model to check\n         */\n        _handleItemVisibleChange: function(itemModel) {\n            if (itemModel.hidden()) {\n                this._handleItemHidden(itemModel);\n            } else {\n                this._handleItemUnhidden(itemModel);\n            }\n            this._renderCounts();\n        },\n\n        _handleItemHidden: function(itemModel) {\n            var contentsShown = this.model.get(\"contents_active\");\n            contentsShown.hidden += 1;\n            contentsShown.active -= 1;\n            if (!this.model.contents.includeHidden) {\n                this.removeItemView(itemModel);\n            }\n            this.model.set(\"contents_active\", contentsShown);\n        },\n\n        _handleItemUnhidden: function(itemModel) {\n            var contentsShown = this.model.get(\"contents_active\");\n            contentsShown.hidden -= 1;\n            if (!this.model.contents.includeHidden) {\n                contentsShown.active -= 1;\n            }\n            this.model.set(\"contents_active\", contentsShown);\n        },\n\n        /** toggle the visibility of each content's tagsEditor applying all the args sent to this function */\n        toggleHDATagEditors: function(showOrHide, speed) {\n            _.each(this.views, view => {\n                if (view.tagsEditor) {\n                    view.tagsEditor.toggle(showOrHide, speed);\n                }\n            });\n        },\n\n        /** toggle the visibility of each content's annotationEditor applying all the args sent to this function */\n        toggleHDAAnnotationEditors: function(showOrHide, speed) {\n            _.each(this.views, view => {\n                if (view.annotationEditor) {\n                    view.annotationEditor.toggle(showOrHide, speed);\n                }\n            });\n        },\n\n        // ------------------------------------------------------------------------ panel events\n        /** event map */\n        events: _.extend(_.clone(_super.prototype.events), {\n            \"click .show-selectors-btn\": \"toggleSelectors\",\n            \"click .toggle-deleted-link\": function(ev) {\n                this.toggleShowDeleted();\n            },\n            \"click .toggle-hidden-link\": function(ev) {\n                this.toggleShowHidden();\n            }\n        }),\n\n        // ------------------------------------------------------------------------ search\n        _renderSearchProgress: function(limit, offset) {\n            var stop = limit + offset;\n            return this.$(\"> .controls .subtitle\").html(\n                [\"<i>\", _l(\"Searching \"), stop, \"/\", this.model.contentsShown(), \"</i>\"].join(\"\")\n            );\n        },\n\n        /** override to display number found in subtitle */\n        _renderSearchFindings: function($whereTo) {\n            $whereTo = $whereTo instanceof jQuery ? $whereTo : this.$el;\n            var html = this.templates.found(this.model.toJSON(), this);\n            $whereTo.find(\"> .controls .subtitle\").html(html);\n            return this;\n        },\n\n        // ------------------------------------------------------------------------ as drop target\n        /** turn all the drag and drop handlers on and add some help text above the drop area */\n        dropTargetOn: function() {\n            if (this.dropTarget) {\n                return this;\n            }\n            this.dropTarget = true;\n\n            //TODO: to init\n            var dropHandlers = {\n                dragenter: _.bind(this.dragenter, this),\n                dragover: _.bind(this.dragover, this),\n                dragleave: _.bind(this.dragleave, this),\n                drop: _.bind(this.drop, this)\n            };\n\n            var $dropTarget = this._renderDropTarget();\n            this.$list().before([this._renderDropTargetHelp(), $dropTarget]);\n            for (var evName in dropHandlers) {\n                if (dropHandlers.hasOwnProperty(evName)) {\n                    //console.debug( evName, dropHandlers[ evName ] );\n                    $dropTarget.on(evName, dropHandlers[evName]);\n                }\n            }\n            return this;\n        },\n\n        /** render a box to serve as a 'drop here' area on the history */\n        _renderDropTarget: function() {\n            this.$(\".history-drop-target\").remove();\n            return $(\"<div/>\").addClass(\"history-drop-target\");\n        },\n\n        /** tell the user how it works  */\n        _renderDropTargetHelp: function() {\n            this.$(\".history-drop-target-help\").remove();\n            return $(\"<div/>\")\n                .addClass(\"history-drop-target-help\")\n                .text(_l(\"Drag datasets here to copy them to the current history\"));\n        },\n\n        /** shut down drag and drop event handlers and remove drop target */\n        dropTargetOff: function() {\n            if (!this.dropTarget) {\n                return this;\n            }\n            //this.log( 'dropTargetOff' );\n            this.dropTarget = false;\n            var dropTarget = this.$(\".history-drop-target\").get(0);\n            for (var evName in this._dropHandlers) {\n                if (this._dropHandlers.hasOwnProperty(evName)) {\n                    dropTarget.off(evName, this._dropHandlers[evName]);\n                }\n            }\n            this.$(\".history-drop-target\").remove();\n            this.$(\".history-drop-target-help\").remove();\n            return this;\n        },\n        /** toggle the target on/off */\n        dropTargetToggle: function() {\n            if (this.dropTarget) {\n                this.dropTargetOff();\n            } else {\n                this.dropTargetOn();\n            }\n            return this;\n        },\n\n        dragenter: function(ev) {\n            //console.debug( 'dragenter:', this, ev );\n            ev.preventDefault();\n            ev.stopPropagation();\n            this.$(\".history-drop-target\").css(\"border\", \"2px solid black\");\n        },\n        dragover: function(ev) {\n            ev.preventDefault();\n            ev.stopPropagation();\n        },\n        dragleave: function(ev) {\n            //console.debug( 'dragleave:', this, ev );\n            ev.preventDefault();\n            ev.stopPropagation();\n            this.$(\".history-drop-target\").css(\"border\", \"1px dashed black\");\n        },\n        /** when (text) is dropped try to parse as json and trigger an event */\n        drop: function(ev) {\n            ev.preventDefault();\n            //ev.stopPropagation();\n\n            var self = this;\n            var dataTransfer = ev.originalEvent.dataTransfer;\n            var data = dataTransfer.getData(\"text\");\n\n            dataTransfer.dropEffect = \"move\";\n            try {\n                data = JSON.parse(data);\n            } catch (err) {\n                self.warn(\"error parsing JSON from drop:\", data);\n            }\n\n            self.trigger(\"droptarget:drop\", ev, data, self);\n            return false;\n        },\n\n        /** handler that copies data into the contents */\n        dataDropped: function(data) {\n            var self = this;\n            // HDA: dropping will copy it to the history\n            if (_.isObject(data) && data.model_class === \"HistoryDatasetAssociation\" && data.id) {\n                if (self.contents.currentPage !== 0) {\n                    return self.contents.fetchPage(0).then(() => self.model.contents.copy(data.id));\n                }\n                return self.model.contents.copy(data.id);\n            }\n            return jQuery.when();\n        },\n\n        // ........................................................................ misc\n        /** Return a string rep of the history */\n        toString: function() {\n            return `HistoryViewEdit(${this.model ? this.model.get(\"name\") : \"\"})`;\n        }\n    }\n);\n\n//------------------------------------------------------------------------------ TEMPLATES\nHistoryViewEdit.prototype.templates = (() => {\n    var countsTemplate = BASE_MVC.wrapTemplate(\n        [\n            \"<% var shown = Math.max( view.views.length, history.contents_active.active ) %>\",\n            \"<% if( shown ){ %>\",\n            '<span class=\"shown-count\">',\n            \"<%- shown %> \",\n            _l(\"shown\"),\n            \"</span>\",\n            \"<% } %>\",\n\n            \"<% if( history.contents_active.deleted ){ %>\",\n            '<span class=\"deleted-count\">',\n            \"<% if( view.model.contents.includeDeleted ){ %>\",\n            '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n            _l(\"hide deleted\"),\n            \"</a>\",\n            \"<% } else { %>\",\n            \"<%- history.contents_active.deleted %> \",\n            '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n            _l(\"deleted\"),\n            \"</a>\",\n            \"<% } %>\",\n            \"</span>\",\n            \"<% } %>\",\n\n            \"<% if( history.contents_active.hidden ){ %>\",\n            '<span class=\"hidden-count\">',\n            \"<% if( view.model.contents.includeHidden ){ %>\",\n            '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n            _l(\"hide hidden\"),\n            \"</a>\",\n            \"<% } else { %>\",\n            \"<%- history.contents_active.hidden %> \",\n            '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n            _l(\"hidden\"),\n            \"</a>\",\n            \"<% } %>\",\n            \"</span>\",\n            \"<% } %>\"\n        ],\n        \"history\"\n    );\n\n    var foundTemplate = BASE_MVC.wrapTemplate(\n        [\n            _l(\"Found\"),\n            \" <%- view.views.length %>, \",\n\n            \"<% if( history.contents_active.deleted ){ %>\",\n            \"<% if( view.model.contents.includeDeleted ){ %>\",\n            '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n            _l(\"hide deleted\"),\n            \"</a>, \",\n            \"<% } else { %>\",\n            '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n            _l(\"show deleted\"),\n            \"</a>, \",\n            \"<% } %>\",\n            \"<% } %>\",\n\n            \"<% if( history.contents_active.hidden ){ %>\",\n            \"<% if( view.model.contents.includeHidden ){ %>\",\n            '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n            _l(\"hide hidden\"),\n            \"</a>\",\n            \"<% } else { %>\",\n            '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n            _l(\"show hidden\"),\n            \"</a>\",\n            \"<% } %>\",\n            \"<% } %>\"\n        ],\n        \"history\"\n    );\n\n    return _.extend(_.clone(_super.prototype.templates), {\n        counts: countsTemplate,\n        found: foundTemplate\n    });\n})();\n\n//==============================================================================\nexport default {\n    HistoryViewEdit: HistoryViewEdit\n};\n"]}