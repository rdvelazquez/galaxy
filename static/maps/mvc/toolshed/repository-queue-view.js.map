{"version":3,"sources":["mvc/toolshed/repository-queue-view.js"],"names":["View","Backbone","extend","el","defaults","initialize","options","that","model","RepoQueue","listenTo","render","fetch","repo_queue_template","templateRepoQueue","repositories","models","$el","html","title","queue","queueLength","$","css","bindEvents","on","repository_metadata","loadFromQueue","attr","installFromQueue","queue_key","repo_queue","JSON","parse","localStorage","hasOwnProperty","repository_id","repository","id","remove","stringify","history","navigate","trigger","replace","params","Object","install_tool_dependencies","install_repository_dependencies","install_resolver_dependencies","tool_panel_section","shed_tool_conf","changeset_revision","tool_shed_repository_ids","tool_shed_url","split","changeset","url","Galaxy","root","undefined","queueKey","repository_queue","post","iri_params","data","new_route","join","console","log","reDraw","empty","_","template","RepoQueueView"],"mappings":"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","file":"../../../scripts/mvc/toolshed/repository-queue-view.js","sourcesContent":["import _l from \"utils/localization\";\nimport toolshed_model from \"mvc/toolshed/toolshed-model\";\nimport toolshed_util from \"mvc/toolshed/util\";\nvar View = Backbone.View.extend({\n    el: \"#center\",\n\n    defaults: [{}],\n\n    initialize: function(options) {\n        var that = this;\n        this.model = new toolshed_model.RepoQueue();\n        this.listenTo(this.model, \"sync\", this.render);\n        this.model.fetch();\n        that.render();\n    },\n\n    render: function(options) {\n        var that = this;\n        var repo_queue_template = that.templateRepoQueue;\n        var repositories = that.model.models;\n        that.$el.html(\n            repo_queue_template({\n                title: _l(\"Repository Installation Queue\"),\n                repositories: repositories,\n                queue: toolshed_util.queueLength()\n            })\n        );\n        $(\"#center\").css(\"overflow\", \"auto\");\n        that.bindEvents();\n    },\n\n    bindEvents: function() {\n        var that = this;\n        $(\".install_one\").on(\"click\", function() {\n            var repository_metadata = that.loadFromQueue($(this).attr(\"data-repokey\"));\n            that.installFromQueue(repository_metadata, $(this).attr(\"data-repokey\"));\n        });\n        $(\".remove_one\").on(\"click\", function() {\n            var queue_key = $(this).attr(\"data-repokey\");\n            var repo_queue = JSON.parse(localStorage.repositories);\n            if (repo_queue.hasOwnProperty(queue_key)) {\n                var repository_id = repo_queue[queue_key].repository.id;\n                delete repo_queue[queue_key];\n                $(`#queued_repository_${repository_id}`).remove();\n            }\n            localStorage.repositories = JSON.stringify(repo_queue);\n        });\n        $(\"#clear_queue\").on(\"click\", () => {\n            localStorage.repositories = \"{}\";\n        });\n        $(\"#from_workflow\").on(\"click\", () => {\n            Backbone.history.navigate(\"workflows\", {\n                trigger: true,\n                replace: true\n            });\n        });\n    },\n\n    installFromQueue: function(repository_metadata, queue_key) {\n        var that = this;\n        var params = Object();\n        params.install_tool_dependencies = repository_metadata.install_tool_dependencies;\n        params.install_repository_dependencies = repository_metadata.install_repository_dependencies;\n        params.install_resolver_dependencies = repository_metadata.install_resolver_dependencies;\n        params.tool_panel_section = repository_metadata.tool_panel_section;\n        params.shed_tool_conf = repository_metadata.shed_tool_conf;\n        params.repositories = JSON.stringify([\n            [repository_metadata.repository.id, repository_metadata.changeset_revision]\n        ]);\n        params.tool_shed_repository_ids = JSON.stringify([repository_metadata.repository.id]);\n        params.tool_shed_url = queue_key.split(\"|\")[0];\n        params.changeset = repository_metadata.changeset_revision;\n        var url = `${Galaxy.root}api/tool_shed_repositories/install?async=True`;\n        $(`#queued_repository_${repository_metadata.repository.id}`).remove();\n        if (localStorage.repositories) {\n            if (queue_key === undefined) {\n                queue_key = toolshed_util.queueKey(repository_metadata);\n            }\n            var repository_queue = JSON.parse(localStorage.repositories);\n            if (repository_queue.hasOwnProperty(queue_key)) {\n                delete repository_queue[queue_key];\n                localStorage.repositories = JSON.stringify(repository_queue);\n            }\n        }\n\n        $.post(url, params, data => {\n            var iri_params = JSON.parse(data);\n            var repositories = iri_params.repositories;\n            var new_route = `status/r/${repositories.join(\"|\")}`;\n            $.post(`${Galaxy.root}admin_toolshed/install_repositories`, iri_params, data => {\n                console.log(\"Initializing repository installation succeeded\");\n            });\n            Backbone.history.navigate(new_route, {\n                trigger: true,\n                replace: true\n            });\n        });\n    },\n\n    loadFromQueue: function(queue_key) {\n        var repository_queue = JSON.parse(localStorage.repositories);\n        if (repository_queue.hasOwnProperty(queue_key)) {\n            return repository_queue[queue_key];\n        }\n        return undefined;\n    },\n\n    reDraw: function(options) {\n        this.$el.empty();\n        this.initialize(options);\n        this.model.fetch();\n        this.render(options);\n    },\n\n    templateRepoQueue: _.template(\n        [\n            '<div class=\"unified-panel-header\" id=\"panel_header\" unselectable=\"on\">',\n            '<div class=\"unified-panel-header-inner\"><%= title %></div>',\n            '<div class=\"unified-panel-header-inner\" style=\"position: absolute; right: 5px; top: 0px;\"><a href=\"#/queue\">Repository Queue (<%= queue %>)</a></div>',\n            \"</div>\",\n            '<div class=\"tab-pane\" id=\"panel_header\" id=\"repository_queue\">',\n            '<table id=\"queued_repositories\" class=\"grid\" border=\"0\" cellpadding=\"2\" cellspacing=\"2\" width=\"100%\">',\n            '<thead id=\"grid-table-header\">',\n            \"<tr>\",\n            '<th class=\"datasetRow\">Name</th>',\n            '<th class=\"datasetRow\">Owner</th>',\n            '<th class=\"datasetRow\">Revision</th>',\n            '<th class=\"datasetRow\">ToolShed</th>',\n            '<th class=\"datasetRow\">Install</th>',\n            '<th class=\"datasetRow\"><input class=\"btn btn-primary\" type=\"submit\" id=\"clear_queue\" name=\"clear_queue\" value=\"Clear queue\" /></th>',\n            \"</tr>\",\n            \"</thead>\",\n            \"<tbody>\",\n            \"<% _.each(repositories, function(repository) { %>\",\n            '<tr id=\"queued_repository_<%= repository.get(\"id\") %>\">',\n            '<td class=\"datasetRow\"><%= repository.get(\"repository\").name %></td>',\n            '<td class=\"datasetRow\"><%= repository.get(\"repository\").owner %></td>',\n            '<td class=\"datasetRow\"><%= repository.get(\"changeset_revision\") %></td>',\n            '<td class=\"datasetRow\"><%= repository.get(\"tool_shed_url\") %></td>',\n            '<td class=\"datasetRow\">',\n            '<input class=\"btn btn-primary install_one\" data-repokey=\"<%= repository.get(\"queue_key\") %>\" type=\"submit\" id=\"install_repository_<%= repository.get(\"id\") %>\" name=\"install_repository\" value=\"Install now\" />',\n            \"</td>\",\n            '<td class=\"datasetRow\">',\n            '<input class=\"btn btn-primary remove_one\" data-repokey=\"<%= repository.get(\"queue_key\") %>\" type=\"submit\" id=\"unqueue_repository_<%= repository.get(\"id\") %>\" name=\"unqueue_repository\" value=\"Remove from queue\" />',\n            \"</td>\",\n            \"</tr>\",\n            \"<% }); %>\",\n            \"</tbody>\",\n            \"</table>\",\n            '<input type=\"button\" class=\"btn btn-primary\" id=\"from_workflow\" value=\"Add from workflow\" />',\n            \"</div>\"\n        ].join(\"\")\n    )\n});\n\nexport default {\n    RepoQueueView: View\n};\n"]}