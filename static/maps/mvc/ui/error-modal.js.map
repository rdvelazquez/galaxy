{"version":3,"sources":["mvc/ui/error-modal.js"],"names":["CONTACT_MSG","DEFAULT_AJAX_ERR_MSG","DETAILS_MSG","_errorModal","message","title","details","Galaxy","modal","show","body","closing_events","buttons","Ok","hide","$el","addClass","$","add","remove","appendTo","append","text","JSON","stringify","click","toggle","errorModal","window","alert","console","log","offlineErrorModal","badGatewayErrorModal","ajaxErrorModal","model","xhr","options","_ajaxDetails","raven","_","result","Raven","userAgent","navigator","onLine","version","config","omit","functions","url","lastAjax","data","user"],"mappings":"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","file":"../../../scripts/mvc/ui/error-modal.js","sourcesContent":["import _l from \"utils/localization\";\n\n//TODO: toastr is another possibility - I didn't see where I might add details, tho\n\n/* ============================================================================\nError modals meant to replace the o-so-easy alerts.\n\nThese are currently styled as errormessages but use the Galaxy.modal\ninfrastructure to be shown/closed. They're capable of showing details in a\ntogglable dropdown and the details are formatted in a pre.\n\nExample:\n    errorModal( 'Heres a message', 'A Title', { some_details: 'here' });\n    errorModal( 'Heres a message' ); // no details, title is 'Error'\n\nThere are three specialized forms:\n    offlineErrorModal       a canned response for when there's no connection\n    badGatewayErrorModal    canned response for when Galaxy is restarting\n    ajaxErrorModal          plugable into any Backbone class as an\n        error event handler by accepting the error args: model, xhr, options\n\nExamples:\n    if( navigator.offLine ){ offlineErrorModal(); }\n    if( xhr.status === 502 ){ badGatewayErrorModal(); }\n    this.listenTo( this.model, 'error', ajaxErrorModal );\n\n============================================================================ */\n\nvar CONTACT_MSG = _l(\"Please contact a Galaxy administrator if the problem persists.\");\nvar DEFAULT_AJAX_ERR_MSG = _l(\"An error occurred while updating information with the server.\");\nvar DETAILS_MSG = _l(\"The following information can assist the developers in finding the source of the error:\");\n\n/** private helper that builds the modal and handles adding details */\nfunction _errorModal(message, title, details) {\n    // create and return the modal, adding details button only if needed\n    Galaxy.modal.show({\n        title: title,\n        body: message,\n        closing_events: true,\n        buttons: {\n            Ok: function() {\n                Galaxy.modal.hide();\n            }\n        }\n    });\n    Galaxy.modal.$el.addClass(\"error-modal\");\n\n    if (details) {\n        Galaxy.modal\n            .$(\".error-details\")\n            .add(Galaxy.modal.$('button:contains(\"Details\")'))\n            .remove();\n        $(\"<div/>\")\n            .addClass(\"error-details\")\n            .hide()\n            .appendTo(Galaxy.modal.$(\".modal-content\"))\n            .append([$(\"<p/>\").text(DETAILS_MSG), $(\"<pre/>\").text(JSON.stringify(details, null, \"  \"))]);\n\n        $(`<button id=\"button-1\" class=\"pull-left\">${_l(\"Details\")}</button>`)\n            .appendTo(Galaxy.modal.$(\".buttons\"))\n            .click(() => {\n                Galaxy.modal.$(\".error-details\").toggle();\n            });\n    }\n    return Galaxy.modal;\n}\n\n/** Display a modal showing an error message but fallback to alert if there's no modal */\nfunction errorModal(message, title, details) {\n    if (!message) {\n        return;\n    }\n\n    message = _l(message);\n    title = _l(title) || _l(\"Error:\");\n    if (window.Galaxy && Galaxy.modal) {\n        return _errorModal(message, title, details);\n    }\n\n    alert(`${title}\\n\\n${message}`);\n    console.log(\"error details:\", JSON.stringify(details));\n}\n\n// ----------------------------------------------------------------------------\n/** display a modal when the user may be offline */\nfunction offlineErrorModal() {\n    return errorModal(_l(\"You appear to be offline. Please check your connection and try again.\"), _l(\"Offline?\"));\n}\n\n// ----------------------------------------------------------------------------\n/** 502 messages that should be displayed when galaxy is restarting */\nfunction badGatewayErrorModal() {\n    return errorModal(\n        `${_l(\"Galaxy is currently unreachable. Please try again in a few minutes.\")} ${CONTACT_MSG}`,\n        _l(\"Cannot connect to Galaxy\")\n    );\n}\n\n// ----------------------------------------------------------------------------\n/** display a modal (with details) about a failed Backbone ajax operation */\nfunction ajaxErrorModal(model, xhr, options, message, title) {\n    message = message || DEFAULT_AJAX_ERR_MSG;\n    message += ` ${CONTACT_MSG}`;\n    title = title || _l(\"An error occurred\");\n    var details = _ajaxDetails(model, xhr, options);\n    return errorModal(message, title, details);\n}\n\n/** build details which may help debugging the ajax call */\nfunction _ajaxDetails(model, xhr, options) {\n    return {\n        //TODO: still can't manage Raven id\n        raven: _.result(window.Raven, \"lastEventId\"),\n        userAgent: navigator.userAgent,\n        onLine: navigator.onLine,\n        version: _.result(Galaxy.config, \"version_major\"),\n        xhr: _.omit(xhr, _.functions(xhr)),\n        options: _.omit(options, \"xhr\"),\n        // add ajax data from Galaxy object cache\n        url: _.result(Galaxy.lastAjax, \"url\"),\n        data: _.result(Galaxy.lastAjax, \"data\"),\n        // backbone stuff (auto-redacting email for user)\n        model: _.result(model, \"toJSON\", `${model}`),\n        user: _.omit(_.result(Galaxy.user, \"toJSON\"), \"email\")\n    };\n}\n\n//=============================================================================\nexport default {\n    errorModal: errorModal,\n    offlineErrorModal: offlineErrorModal,\n    badGatewayErrorModal: badGatewayErrorModal,\n    ajaxErrorModal: ajaxErrorModal\n};\n"]}