{"version":3,"sources":["viz/visualization.js"],"names":["_","CustomToJSON","toJSON","self","json","each","constructor","to_json_keys","val","get","k","to_json_mappers","select_datasets","filters","success_fn","history_grid","url_base","Galaxy","root","embedded","library_grid","tabs","View","add","id","title","$el","$","append","modal","show","body","closing_events","buttons","Cancel","hide","Add","requests","window","console","log","length","ajax","url","dataType","data","data_type","hda_ldda","current","when","apply","then","track_defs","arguments","Array","map","arg","CanvasManager","default_font","undefined","dummy_canvas","new_canvas","dummy_context","getContext","font","char_width_px","measureText","width","patterns","load_pattern","extend","prototype","key","path","image","Image","src","onload","createPattern","get_pattern","canvas","manager","Cache","Backbone","Model","defaults","num_elements","obj_cache","key_ary","initialize","options","clear","get_elt","attributes","key_str","toString","index","indexOf","stale","splice","move_key_to_end","set_elt","value","deleted_key","shift","push","size","most_recently_added","GenomeDataManager","dataset","genome","init_data","min_region_size","filters_manager","data_mode_compatible","entry","mode","can_subset","call","initial_entries","add_data","entries","set","set_data","region","data_is_ready","ready_deferred","Deferred","query_type","ss_deferred","ServerStateDeferred","ajax_settings","interval","response","go","resolve","search_features","query","params","getJSON","load_data","resolution","extra_params","chrom","low","high","filter_names","i","name","filter_cols","JSON","stringify","result","get_data","is_deferred","entry_region","is_subregion","contains","subset_entry","copy","last_request","trim","DEEP_DATA_REQ","BROAD_DATA_REQ","get_more_data","req_type","cur_data","_mark_stale","query_low","start_val","max_high","query_region","data_manager","new_data_request","new_data_available","concat","max_low","message","replace","can_get_more_detailed_data","dataset_type","get_more_detailed_data","detail_multiplier","num_samples","get_genome_wide_data","all_data_available","gw_data","chrom_info","chrom_data","GenomeRegion","start","end","len","deferred","genome_wide_data","subregion","subset_fns","bigwig","filter","data_point","refseq","seq_start","slice","subregion_data","same","GenomeReferenceDataManager","dataset_placeholder","urlRoot","data_url","Genome","chroms_info","dbkey","get_chroms_info","get_chrom_region","chr_name","find","get_chrom_len","str_val","from_str","pieces","split","start_end","parseInt","on","compute_overlap","a_region","first_chrom","second_chrom","first_start","second_start","first_end","second_end","overlap","overlap_results","DIF_CHROMS","BEFORE","OVERLAP_START","CONTAINS","AFTER","CONTAINED_BY","OVERLAP_END","chrom_len","overlaps","intersection","GenomeRegionCollection","Collection","model","BrowserBookmark","note","BrowserBookmarkCollection","BackboneTrack","Dataset","models","default_value","label","type","ConfigSettingCollection","from_models_and_saved_values","prefs","preloaded_data","p","color","d","BackboneTrackCollection","Visualization","save","vis_json","GenomeVisualization","drawables","bookmarks","viewport","tracks","unset","add_tracks","view","dummy","obj_type","content_visible","TrackBrowserRouter","Router","route","navigate","new_loc","change_location","go_to"],"mappings":"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","file":"../../scripts/viz/visualization.js","sourcesContent":["import _l from \"utils/localization\";\nimport * as _ from \"libs/underscore\";\nimport data_mod from \"mvc/dataset/data\";\nimport util_mod from \"viz/trackster/util\";\nimport config_mod from \"utils/config\";\nimport GridView from \"mvc/grid/grid-view\";\nimport Tabs from \"mvc/ui/ui-tabs\";\n/**\n * Mixin for returning custom JSON representation from toJSON. Class attribute to_json_keys defines a set of attributes\n * to include in the representation; to_json_mappers defines mappers for returned objects.\n */\nvar CustomToJSON = {\n    /**\n     * Returns JSON representation of object using to_json_keys and to_json_mappers.\n     */\n    toJSON: function() {\n        var self = this;\n        var json = {};\n        _.each(self.constructor.to_json_keys, k => {\n            var val = self.get(k);\n            if (k in self.constructor.to_json_mappers) {\n                val = self.constructor.to_json_mappers[k](val, self);\n            }\n            json[k] = val;\n        });\n        return json;\n    }\n};\n\n/**\n * Model, view, and controller objects for Galaxy visualization framework.\n *\n * Models have no references to views, instead using events to indicate state\n * changes; this is advantageous because multiple views can use the same object\n * and models can be used without views.\n */\n\n/**\n * Use a popup grid to select datasets from histories or libraries. After datasets are selected,\n * track definitions are obtained from the server and the success_fn is called with the list of\n * definitions for selected datasets.\n */\nvar select_datasets = (filters, success_fn) => {\n    // history dataset selection tab\n    var history_grid = new GridView({\n        url_base: `${Galaxy.root}visualization/list_history_datasets`,\n        filters: filters,\n        embedded: true\n    });\n\n    // library dataset selection tab\n    var library_grid = new GridView({\n        url_base: `${Galaxy.root}visualization/list_library_datasets`,\n        embedded: true\n    });\n\n    // build tabs\n    var tabs = new Tabs.View();\n    tabs.add({\n        id: \"histories\",\n        title: _l(\"Histories\"),\n        $el: $(\"<div/>\").append(history_grid.$el)\n    });\n    tabs.add({\n        id: \"libraries\",\n        title: _l(\"Libraries\"),\n        $el: $(\"<div/>\").append(library_grid.$el)\n    });\n\n    // modal\n    Galaxy.modal.show({\n        title: _l(\"Select datasets for new tracks\"),\n        body: tabs.$el,\n        closing_events: true,\n        buttons: {\n            Cancel: function() {\n                Galaxy.modal.hide();\n            },\n            Add: function() {\n                var requests = [];\n                tabs.$(\"input.grid-row-select-checkbox[name=id]:checked\").each(function() {\n                    window.console.log($(this).val());\n                    requests[requests.length] = $.ajax({\n                        url: `${Galaxy.root}api/datasets/${$(this).val()}`,\n                        dataType: \"json\",\n                        data: {\n                            data_type: \"track_config\",\n                            hda_ldda: tabs.current() == \"histories\" ? \"hda\" : \"ldda\"\n                        }\n                    });\n                });\n                // To preserve order, wait until there are definitions for all tracks and then add\n                // them sequentially.\n                $.when.apply($, requests).then(function() {\n                    // jQuery always returns an Array for arguments, so need to look at first element\n                    // to determine whether multiple requests were made and consequently how to\n                    // map arguments to track definitions.\n                    var track_defs = arguments[0] instanceof Array ? $.map(arguments, arg => arg[0]) : [arguments[0]];\n                    success_fn(track_defs);\n                });\n                Galaxy.modal.hide();\n            }\n        }\n    });\n};\n\n// --------- Models ---------\n\n/**\n * Canvas manager is used to create canvases for browsers as well as providing a pattern cache\n */\nvar CanvasManager = function(default_font) {\n    this.default_font = default_font !== undefined ? default_font : \"9px Monaco, Lucida Console, monospace\";\n\n    this.dummy_canvas = this.new_canvas();\n    this.dummy_context = this.dummy_canvas.getContext(\"2d\");\n    this.dummy_context.font = this.default_font;\n\n    this.char_width_px = this.dummy_context.measureText(\"A\").width;\n\n    this.patterns = {};\n\n    // FIXME: move somewhere to make this more general\n    this.load_pattern(\"right_strand\", \"/visualization/strand_right.png\");\n    this.load_pattern(\"left_strand\", \"/visualization/strand_left.png\");\n    this.load_pattern(\"right_strand_inv\", \"/visualization/strand_right_inv.png\");\n    this.load_pattern(\"left_strand_inv\", \"/visualization/strand_left_inv.png\");\n};\n\n_.extend(CanvasManager.prototype, {\n    load_pattern: function(key, path) {\n        var patterns = this.patterns;\n        var dummy_context = this.dummy_context;\n        var image = new Image();\n        image.src = `${Galaxy.root}static/images${path}`;\n        image.onload = () => {\n            patterns[key] = dummy_context.createPattern(image, \"repeat\");\n        };\n    },\n    get_pattern: function(key) {\n        return this.patterns[key];\n    },\n    new_canvas: function() {\n        var canvas = $(\"<canvas/>\")[0];\n        // Keep a reference back to the manager\n        canvas.manager = this;\n        return canvas;\n    }\n});\n\n/**\n * Generic cache that handles key/value pairs. Keys can be any object that can be\n * converted to a String and compared.\n */\nvar Cache = Backbone.Model.extend({\n    defaults: {\n        num_elements: 20,\n        // Objects in cache; indexes into cache are strings of keys.\n        obj_cache: null,\n        // key_ary contains keys for objects in cache.\n        key_ary: null\n    },\n\n    initialize: function(options) {\n        this.clear();\n    },\n\n    /**\n     * Get an element from the cache using its key.\n     */\n    get_elt: function(key) {\n        var obj_cache = this.attributes.obj_cache;\n        var key_ary = this.attributes.key_ary;\n        var key_str = key.toString();\n\n        var index = _.indexOf(key_ary, k => k.toString() === key_str);\n\n        // Update cache.\n        if (index !== -1) {\n            // Object is in cache, so update it.\n            if (obj_cache[key_str].stale) {\n                // Object is stale: remove key and object.\n                key_ary.splice(index, 1);\n                delete obj_cache[key_str];\n            } else {\n                // Move key to back because it is most recently used.\n                this.move_key_to_end(key, index);\n            }\n        }\n\n        return obj_cache[key_str];\n    },\n\n    /**\n     * Put an element into the cache.\n     */\n    set_elt: function(key, value) {\n        var obj_cache = this.attributes.obj_cache;\n        var key_ary = this.attributes.key_ary;\n        var key_str = key.toString();\n        var num_elements = this.attributes.num_elements;\n\n        // Update keys, objects.\n        if (!obj_cache[key_str]) {\n            // Add object to cache.\n\n            if (key_ary.length >= num_elements) {\n                // Cache full, so remove first element.\n                var deleted_key = key_ary.shift();\n                delete obj_cache[deleted_key.toString()];\n            }\n\n            // Add key.\n            key_ary.push(key);\n        }\n\n        // Add object.\n        obj_cache[key_str] = value;\n        return value;\n    },\n\n    /**\n     * Move key to end of cache. Keys are removed from the front, so moving a key to the end\n     * delays the key's removal.\n     */\n    move_key_to_end: function(key, index) {\n        this.attributes.key_ary.splice(index, 1);\n        this.attributes.key_ary.push(key);\n    },\n\n    /**\n     * Clear all elements from the cache.\n     */\n    clear: function() {\n        this.attributes.obj_cache = {};\n        this.attributes.key_ary = [];\n    },\n\n    /** Returns the number of elements in the cache. */\n    size: function() {\n        return this.attributes.key_ary.length;\n    },\n\n    /** Returns key most recently added to cache. */\n    most_recently_added: function() {\n        return this.size() === 0\n            ? null\n            : // Most recent key is at the end of key array.\n              this.attributes.key_ary[this.attributes.key_ary.length - 1];\n    }\n});\n\n/**\n * Data manager for genomic data. Data is connected to and queryable by genomic regions.\n */\nvar GenomeDataManager = Cache.extend({\n    defaults: _.extend({}, Cache.prototype.defaults, {\n        dataset: null,\n        genome: null,\n        init_data: null,\n        min_region_size: 200,\n        filters_manager: null,\n        data_type: \"data\",\n        data_mode_compatible: function(entry, mode) {\n            return true;\n        },\n        can_subset: function(entry) {\n            return false;\n        }\n    }),\n\n    /**\n     * Initialization.\n     */\n    initialize: function(options) {\n        Cache.prototype.initialize.call(this);\n\n        // Set initial entries in data manager.\n        var initial_entries = this.get(\"init_data\");\n        if (initial_entries) {\n            this.add_data(initial_entries);\n        }\n    },\n\n    /**\n     * Add data entries to manager; each entry should be a dict with attributes region (key), data, and data_type.\n     * If necessary, manager size is increased to hold all data.\n     */\n    add_data: function(entries) {\n        // Increase size to accomodate all entries.\n        if (this.get(\"num_elements\") < entries.length) {\n            this.set(\"num_elements\", entries.length);\n        }\n\n        // Put data into manager.\n        var self = this;\n        _.each(entries, entry => {\n            self.set_data(entry.region, entry);\n        });\n    },\n\n    /**\n     * Returns deferred that resolves to true when dataset is ready (or false if dataset\n     * cannot be used).\n     */\n    data_is_ready: function() {\n        var dataset = this.get(\"dataset\");\n        var ready_deferred = $.Deferred();\n\n        var // If requesting raw data, query dataset state; if requesting (converted) data,\n        // need to query converted datasets state.\n        query_type =\n            this.get(\"data_type\") === \"raw_data\"\n                ? \"state\"\n                : this.get(\"data_type\") === \"data\" ? \"converted_datasets_state\" : \"error\";\n\n        var ss_deferred = new util_mod.ServerStateDeferred({\n            ajax_settings: {\n                url: this.get(\"dataset\").url(),\n                data: {\n                    hda_ldda: dataset.get(\"hda_ldda\"),\n                    data_type: query_type\n                },\n                dataType: \"json\"\n            },\n            interval: 5000,\n            success_fn: function(response) {\n                return response !== \"pending\";\n            }\n        });\n\n        $.when(ss_deferred.go()).then(response => {\n            ready_deferred.resolve(response === \"ok\" || response === \"data\");\n        });\n        return ready_deferred;\n    },\n\n    /**\n     * Perform a feature search from server; returns Deferred object that resolves when data is available.\n     */\n    search_features: function(query) {\n        var dataset = this.get(\"dataset\");\n\n        var params = {\n            query: query,\n            hda_ldda: dataset.get(\"hda_ldda\"),\n            data_type: \"features\"\n        };\n\n        return $.getJSON(dataset.url(), params);\n    },\n\n    /**\n     * Load data from server and manages data entries. Adds a Deferred to manager\n     * for region; when data becomes available, replaces Deferred with data.\n     * Returns the Deferred that resolves when data is available.\n     */\n    load_data: function(region, mode, resolution, extra_params) {\n        // Setup data request params.\n        var dataset = this.get(\"dataset\");\n\n        var params = {\n            data_type: this.get(\"data_type\"),\n            chrom: region.get(\"chrom\"),\n            low: region.get(\"start\"),\n            high: region.get(\"end\"),\n            mode: mode,\n            resolution: resolution,\n            hda_ldda: dataset.get(\"hda_ldda\")\n        };\n\n        $.extend(params, extra_params);\n\n        // Add track filters to params.\n        var filters_manager = this.get(\"filters_manager\");\n        if (filters_manager) {\n            var filter_names = [];\n            var filters = filters_manager.filters;\n            for (var i = 0; i < filters.length; i++) {\n                filter_names.push(filters[i].name);\n            }\n            params.filter_cols = JSON.stringify(filter_names);\n        }\n\n        // Do request.\n        var manager = this;\n\n        var entry = $.getJSON(dataset.url(), params, result => {\n            // Add region to the result.\n            result.region = region;\n            manager.set_data(region, result);\n        });\n\n        this.set_data(region, entry);\n        return entry;\n    },\n\n    /**\n     * Get data from dataset.\n     */\n    get_data: function(region, mode, resolution, extra_params) {\n        // Look for entry and return if it's a deferred or if data available is compatible with mode.\n        var entry = this.get_elt(region);\n        if (entry && (util_mod.is_deferred(entry) || this.get(\"data_mode_compatible\")(entry, mode))) {\n            return entry;\n        }\n\n        //\n        // Look in cache for data that can be used.\n        // TODO: this logic could be improved if the visualization knew whether\n        // the data was \"index\" or \"data.\"\n        //\n        var key_ary = this.get(\"key_ary\");\n\n        var obj_cache = this.get(\"obj_cache\");\n        var entry_region;\n        var is_subregion;\n        for (var i = 0; i < key_ary.length; i++) {\n            entry_region = key_ary[i];\n\n            if (entry_region.contains(region)) {\n                is_subregion = true;\n\n                // This entry has data in the requested range. Return if data\n                // is compatible and can be subsetted.\n                entry = obj_cache[entry_region.toString()];\n                if (\n                    util_mod.is_deferred(entry) ||\n                    (this.get(\"data_mode_compatible\")(entry, mode) && this.get(\"can_subset\")(entry))\n                ) {\n                    this.move_key_to_end(entry_region, i);\n\n                    // If there's data, subset it.\n                    if (!util_mod.is_deferred(entry)) {\n                        var subset_entry = this.subset_entry(entry, region);\n                        this.set_data(region, subset_entry);\n                        entry = subset_entry;\n                    }\n\n                    return entry;\n                }\n            }\n        }\n\n        // FIXME: There _may_ be instances where region is a subregion of another entry but cannot be\n        // subsetted. For these cases, do not increase length because region will never be found (and\n        // an infinite loop will occur.)\n        // If needed, extend region to make it minimum size.\n        if (!is_subregion && region.length() < this.attributes.min_region_size) {\n            // IDEA: alternative heuristic is to find adjacent cache entry to region and use that to extend.\n            // This would prevent bad extensions when zooming in/out while still preserving the behavior\n            // below.\n\n            // Use copy of region to avoid changing actual region.\n            region = region.copy();\n\n            // Use heuristic to extend region: extend relative to last data request.\n            var last_request = this.most_recently_added();\n            if (!last_request || region.get(\"start\") > last_request.get(\"start\")) {\n                // This request is after the last request, so extend right.\n                region.set(\"end\", region.get(\"start\") + this.attributes.min_region_size);\n            } else {\n                // This request is after the last request, so extend left.\n                region.set(\"start\", region.get(\"end\") - this.attributes.min_region_size);\n            }\n\n            // Trim region to avoid invalid coordinates.\n            region.set(\"genome\", this.attributes.genome);\n            region.trim();\n        }\n\n        return this.load_data(region, mode, resolution, extra_params);\n    },\n\n    /**\n     * Alias for set_elt for readbility.\n     */\n    set_data: function(region, entry) {\n        this.set_elt(region, entry);\n    },\n\n    /** \"Deep\" data request; used as a parameter for DataManager.get_more_data() */\n    DEEP_DATA_REQ: \"deep\",\n\n    /** \"Broad\" data request; used as a parameter for DataManager.get_more_data() */\n    BROAD_DATA_REQ: \"breadth\",\n\n    /**\n     * Gets more data for a region using either a depth-first or a breadth-first approach.\n     */\n    get_more_data: function(region, mode, resolution, extra_params, req_type) {\n        var cur_data = this._mark_stale(region);\n        if (!(cur_data && this.get(\"data_mode_compatible\")(cur_data, mode))) {\n            console.log(\"ERROR: problem with getting more data: current data is not compatible\");\n            return;\n        }\n\n        //\n        // Set parameters based on request type.\n        //\n        var query_low = region.get(\"start\");\n        if (req_type === this.DEEP_DATA_REQ) {\n            // Use same interval but set start_val to skip data that's already in cur_data.\n            $.extend(extra_params, {\n                start_val: cur_data.data.length + 1\n            });\n        } else if (req_type === this.BROAD_DATA_REQ) {\n            // To get past an area of extreme feature depth, set query low to be after either\n            // (a) the maximum high or HACK/FIXME (b) the end of the last feature returned.\n            query_low = (cur_data.max_high ? cur_data.max_high : cur_data.data[cur_data.data.length - 1][2]) + 1;\n        }\n        var query_region = region.copy().set(\"start\", query_low);\n\n        //\n        // Get additional data, append to current data, and set new data. Use a custom deferred object\n        // to signal when new data is available.\n        //\n        var data_manager = this;\n\n        var new_data_request = this.load_data(query_region, mode, resolution, extra_params);\n\n        var new_data_available = $.Deferred();\n        // load_data sets cache to new_data_request, but use custom deferred object so that signal and data\n        // is all data, not just new data.\n        this.set_data(region, new_data_available);\n        $.when(new_data_request).then(result => {\n            // Update data and message.\n            if (result.data) {\n                result.data = cur_data.data.concat(result.data);\n                if (result.max_low) {\n                    result.max_low = cur_data.max_low;\n                }\n                if (result.message) {\n                    // HACK: replace number in message with current data length. Works but is ugly.\n                    result.message = result.message.replace(/[0-9]+/, result.data.length);\n                }\n            }\n            data_manager.set_data(region, result);\n            new_data_available.resolve(result);\n        });\n        return new_data_available;\n    },\n\n    /**\n     * Returns true if more detailed data can be obtained for entry.\n     */\n    can_get_more_detailed_data: function(region) {\n        var cur_data = this.get_elt(region);\n\n        // Can only get more detailed data for bigwig data that has less than 8000 data points.\n        // Summary tree returns *way* too much data, and 8000 data points ~ 500KB.\n        return cur_data.dataset_type === \"bigwig\" && cur_data.data.length < 8000;\n    },\n\n    /**\n     * Returns more detailed data for an entry.\n     */\n    get_more_detailed_data: function(region, mode, resolution, detail_multiplier, extra_params) {\n        // Mark current entry as stale.\n        var cur_data = this._mark_stale(region);\n        if (!cur_data) {\n            console.log(\"ERROR getting more detailed data: no current data\");\n            return;\n        }\n\n        if (!extra_params) {\n            extra_params = {};\n        }\n\n        // Use additional parameters to get more detailed data.\n        if (cur_data.dataset_type === \"bigwig\") {\n            // FIXME: constant should go somewhere.\n            extra_params.num_samples = 1000 * detail_multiplier;\n        }\n\n        return this.load_data(region, mode, resolution, extra_params);\n    },\n\n    /**\n     * Marks cache data as stale.\n     */\n    _mark_stale: function(region) {\n        var entry = this.get_elt(region);\n        if (!entry) {\n            console.log(\"ERROR: no data to mark as stale: \", this.get(\"dataset\"), region.toString());\n        }\n        entry.stale = true;\n        return entry;\n    },\n\n    /**\n     * Returns an array of data with each entry representing one chromosome/contig\n     * of data or, if data is not available, returns a Deferred that resolves to the\n     * data when it becomes available.\n     */\n    get_genome_wide_data: function(genome) {\n        // -- Get all data. --\n\n        var self = this;\n\n        var all_data_available = true;\n\n        var //  Map chromosome info into genome data.\n        gw_data = _.map(genome.get(\"chroms_info\").chrom_info, chrom_info => {\n            var chrom_data = self.get_elt(\n                new GenomeRegion({\n                    chrom: chrom_info.chrom,\n                    start: 0,\n                    end: chrom_info.len\n                })\n            );\n\n            // Set flag if data is not available.\n            if (!chrom_data) {\n                all_data_available = false;\n            }\n\n            return chrom_data;\n        });\n\n        // -- If all data is available, return it. --\n        if (all_data_available) {\n            return gw_data;\n        }\n\n        // -- All data is not available, so load from server. --\n\n        var deferred = $.Deferred();\n        $.getJSON(this.get(\"dataset\").url(), { data_type: \"genome_data\" }, genome_wide_data => {\n            self.add_data(genome_wide_data.data);\n            deferred.resolve(genome_wide_data.data);\n        });\n\n        return deferred;\n    },\n\n    /**\n     * Returns entry with only data in the subregion.\n     */\n    subset_entry: function(entry, subregion) {\n        // Dictionary from entry type to function for subsetting data.\n        var subset_fns = {\n            bigwig: function(data, subregion) {\n                return _.filter(\n                    data,\n                    data_point => data_point[0] >= subregion.get(\"start\") && data_point[0] <= subregion.get(\"end\")\n                );\n            },\n            refseq: function(data, subregion) {\n                var seq_start = subregion.get(\"start\") - entry.region.get(\"start\");\n                return entry.data.slice(seq_start, seq_start + subregion.length());\n            }\n        };\n\n        // Subset entry if there is a function for subsetting and regions are not the same.\n        var subregion_data = entry.data;\n        if (!entry.region.same(subregion) && entry.dataset_type in subset_fns) {\n            subregion_data = subset_fns[entry.dataset_type](entry.data, subregion);\n        }\n\n        // Return entry with subregion's data.\n        return {\n            region: subregion,\n            data: subregion_data,\n            dataset_type: entry.dataset_type\n        };\n    }\n});\n\nvar GenomeReferenceDataManager = GenomeDataManager.extend({\n    initialize: function(options) {\n        // Use generic object in place of dataset and set urlRoot to fetch data.\n        var dataset_placeholder = new Backbone.Model();\n        dataset_placeholder.urlRoot = options.data_url;\n        this.set(\"dataset\", dataset_placeholder);\n    },\n\n    load_data: function(region, mode, resolution, extra_params) {\n        // Fetch data if region is not too large.\n        return region.length() <= 100000\n            ? GenomeDataManager.prototype.load_data.call(this, region, mode, resolution, extra_params)\n            : { data: null, region: region };\n    }\n});\n\n/**\n * A genome build.\n */\nvar Genome = Backbone.Model.extend({\n    defaults: {\n        name: null,\n        key: null,\n        chroms_info: null\n    },\n\n    initialize: function(options) {\n        this.id = options.dbkey;\n    },\n\n    /**\n     * Shorthand for getting to chromosome information.\n     */\n    get_chroms_info: function() {\n        return this.attributes.chroms_info.chrom_info;\n    },\n\n    /**\n     * Returns a GenomeRegion object denoting a complete chromosome.\n     */\n    get_chrom_region: function(chr_name) {\n        // FIXME: use findWhere in underscore 1.4\n        var chrom_info = _.find(this.get_chroms_info(), chrom_info => chrom_info.chrom === chr_name);\n        return new GenomeRegion({\n            chrom: chrom_info.chrom,\n            end: chrom_info.len\n        });\n    },\n\n    /** Returns the length of a chromosome. */\n    get_chrom_len: function(chr_name) {\n        // FIXME: use findWhere in underscore 1.4\n        return _.find(this.get_chroms_info(), chrom_info => chrom_info.chrom === chr_name).len;\n    }\n});\n\n/**\n * A genomic region.\n */\nvar GenomeRegion = Backbone.Model.extend(\n    {\n        defaults: {\n            chrom: null,\n            start: 0,\n            end: 0,\n            str_val: null,\n            genome: null\n        },\n\n        /**\n         * Returns true if this region is the same as a given region.\n         * It does not test the genome right now.\n         */\n        same: function(region) {\n            return (\n                this.attributes.chrom === region.get(\"chrom\") &&\n                this.attributes.start === region.get(\"start\") &&\n                this.attributes.end === region.get(\"end\")\n            );\n        },\n\n        /**\n         * If from_str specified, use it to initialize attributes.\n         */\n        initialize: function(options) {\n            if (options.from_str) {\n                var pieces = options.from_str.split(\":\");\n                var chrom = pieces[0];\n                var start_end = pieces[1].split(\"-\");\n                this.set({\n                    chrom: chrom,\n                    start: parseInt(start_end[0], 10),\n                    end: parseInt(start_end[1], 10)\n                });\n            }\n\n            // Keep a copy of region's string value for fast lookup.\n            this.attributes.str_val = `${this.get(\"chrom\")}:${this.get(\"start\")}-${this.get(\"end\")}`;\n\n            // Set str_val on attribute change.\n            this.on(\n                \"change\",\n                function() {\n                    this.attributes.str_val = `${this.get(\"chrom\")}:${this.get(\"start\")}-${this.get(\"end\")}`;\n                },\n                this\n            );\n        },\n\n        copy: function() {\n            return new GenomeRegion({\n                chrom: this.get(\"chrom\"),\n                start: this.get(\"start\"),\n                end: this.get(\"end\")\n            });\n        },\n\n        length: function() {\n            return this.get(\"end\") - this.get(\"start\");\n        },\n\n        /** Returns region in canonical form chrom:start-end */\n        toString: function() {\n            return this.attributes.str_val;\n        },\n\n        toJSON: function() {\n            return {\n                chrom: this.get(\"chrom\"),\n                start: this.get(\"start\"),\n                end: this.get(\"end\")\n            };\n        },\n\n        /**\n         * Compute the type of overlap between this region and another region. The overlap is computed relative to the given/second region;\n         * hence, OVERLAP_START indicates that the first region overlaps the start (but not the end) of the second region.\n         */\n        compute_overlap: function(a_region) {\n            var first_chrom = this.get(\"chrom\");\n            var second_chrom = a_region.get(\"chrom\");\n            var first_start = this.get(\"start\");\n            var second_start = a_region.get(\"start\");\n            var first_end = this.get(\"end\");\n            var second_end = a_region.get(\"end\");\n            var overlap;\n\n            // Compare chroms.\n            if (first_chrom && second_chrom && first_chrom !== second_chrom) {\n                return GenomeRegion.overlap_results.DIF_CHROMS;\n            }\n\n            // Compare regions.\n            if (first_start < second_start) {\n                if (first_end < second_start) {\n                    overlap = GenomeRegion.overlap_results.BEFORE;\n                } else if (first_end < second_end) {\n                    overlap = GenomeRegion.overlap_results.OVERLAP_START;\n                } else {\n                    // first_end >= second_end\n                    overlap = GenomeRegion.overlap_results.CONTAINS;\n                }\n            } else if (first_start > second_start) {\n                if (first_start > second_end) {\n                    overlap = GenomeRegion.overlap_results.AFTER;\n                } else if (first_end <= second_end) {\n                    overlap = GenomeRegion.overlap_results.CONTAINED_BY;\n                } else {\n                    overlap = GenomeRegion.overlap_results.OVERLAP_END;\n                }\n            } else {\n                // first_start === second_start\n                overlap =\n                    first_end >= second_end\n                        ? GenomeRegion.overlap_results.CONTAINS\n                        : GenomeRegion.overlap_results.CONTAINED_BY;\n            }\n\n            return overlap;\n        },\n\n        /**\n         * Trim a region to match genome's constraints.\n         */\n        trim: function(genome) {\n            // Assume that all chromosome/contigs start at 0.\n            if (this.attributes.start < 0) {\n                this.attributes.start = 0;\n            }\n\n            // Only try to trim the end if genome is set.\n            if (this.attributes.genome) {\n                var chrom_len = this.attributes.genome.get_chrom_len(this.attributes.chrom);\n                if (this.attributes.end > chrom_len) {\n                    this.attributes.end = chrom_len - 1;\n                }\n            }\n\n            return this;\n        },\n\n        /**\n         * Returns true if this region contains a given region.\n         */\n        contains: function(a_region) {\n            return this.compute_overlap(a_region) === GenomeRegion.overlap_results.CONTAINS;\n        },\n\n        /**\n         * Returns true if regions overlap.\n         */\n        overlaps: function(a_region) {\n            return (\n                _.intersection(\n                    [this.compute_overlap(a_region)],\n                    [\n                        GenomeRegion.overlap_results.DIF_CHROMS,\n                        GenomeRegion.overlap_results.BEFORE,\n                        GenomeRegion.overlap_results.AFTER\n                    ]\n                ).length === 0\n            );\n        }\n    },\n    {\n        overlap_results: {\n            DIF_CHROMS: 1000,\n            BEFORE: 1001,\n            CONTAINS: 1002,\n            OVERLAP_START: 1003,\n            OVERLAP_END: 1004,\n            CONTAINED_BY: 1005,\n            AFTER: 1006\n        }\n    }\n);\n\nvar GenomeRegionCollection = Backbone.Collection.extend({\n    model: GenomeRegion\n});\n\n/**\n * A genome browser bookmark.\n */\nvar BrowserBookmark = Backbone.Model.extend({\n    defaults: {\n        region: null,\n        note: \"\"\n    },\n\n    initialize: function(options) {\n        this.set(\"region\", new GenomeRegion(options.region));\n    }\n});\n\n/**\n * Bookmarks collection.\n */\nvar BrowserBookmarkCollection = Backbone.Collection.extend({\n    model: BrowserBookmark\n});\n\n/**\n * A track of data in a genome visualization.\n */\n// TODO: rename to Track and merge with Trackster's Track object.\nvar BackboneTrack = Backbone.Model.extend(CustomToJSON).extend(\n    {\n        defaults: {\n            mode: \"Auto\"\n        },\n\n        initialize: function(options) {\n            this.set(\"dataset\", new data_mod.Dataset(options.dataset));\n\n            // -- Set up config settings. --\n            var models = [\n                {\n                    key: \"name\",\n                    default_value: this.get(\"dataset\").get(\"name\")\n                },\n                { key: \"color\" },\n                {\n                    key: \"min_value\",\n                    label: \"Min Value\",\n                    type: \"float\",\n                    default_value: 0\n                },\n                {\n                    key: \"max_value\",\n                    label: \"Max Value\",\n                    type: \"float\",\n                    default_value: 1\n                }\n            ];\n\n            this.set(\"config\", config_mod.ConfigSettingCollection.from_models_and_saved_values(models, options.prefs));\n\n            // -- Set up data manager. --\n            var preloaded_data = this.get(\"preloaded_data\");\n            if (preloaded_data) {\n                preloaded_data = preloaded_data.data;\n            } else {\n                preloaded_data = [];\n            }\n            this.set(\n                \"data_manager\",\n                new GenomeDataManager({\n                    dataset: this.get(\"dataset\"),\n                    init_data: preloaded_data\n                })\n            );\n        }\n    },\n    {\n        // This definition matches that produced by to_dict() methods in tracks.js\n        to_json_keys: [\"track_type\", \"dataset\", \"prefs\", \"mode\", \"filters\", \"tool_state\"],\n        to_json_mappers: {\n            prefs: function(p, self) {\n                if (_.size(p) === 0) {\n                    p = {\n                        name: self\n                            .get(\"config\")\n                            .get(\"name\")\n                            .get(\"value\"),\n                        color: self\n                            .get(\"config\")\n                            .get(\"color\")\n                            .get(\"value\")\n                    };\n                }\n                return p;\n            },\n            dataset: function(d) {\n                return {\n                    id: d.id,\n                    hda_ldda: d.get(\"hda_ldda\")\n                };\n            }\n        }\n    }\n);\n\nvar BackboneTrackCollection = Backbone.Collection.extend({\n    model: BackboneTrack\n});\n\n/**\n * A visualization.\n */\nvar Visualization = Backbone.Model.extend({\n    defaults: {\n        title: \"\",\n        type: \"\"\n    },\n\n    urlRoot: `${Galaxy.root}api/visualizations`,\n\n    /**\n     * POSTs visualization's JSON to its URL using the parameter 'vis_json'\n     * Note: This is necessary because (a) Galaxy requires keyword args and\n     * (b) Galaxy does not handle PUT now.\n     */\n    save: function() {\n        return $.ajax({\n            url: this.url(),\n            type: \"POST\",\n            dataType: \"json\",\n            data: {\n                vis_json: JSON.stringify(this)\n            }\n        });\n    }\n});\n\n/**\n * A visualization of genome data.\n */\nvar GenomeVisualization = Visualization.extend(CustomToJSON).extend(\n    {\n        defaults: _.extend({}, Visualization.prototype.defaults, {\n            dbkey: \"\",\n            drawables: null,\n            bookmarks: null,\n            viewport: null\n        }),\n\n        initialize: function(options) {\n            // Replace drawables with tracks.\n            this.set(\"drawables\", new BackboneTrackCollection(options.tracks));\n\n            var models = [];\n            this.set(\"config\", config_mod.ConfigSettingCollection.from_models_and_saved_values(models, options.prefs));\n\n            // Clear track and data definitions to avoid storing large objects.\n            this.unset(\"tracks\");\n            this.get(\"drawables\").each(d => {\n                d.unset(\"preloaded_data\");\n            });\n        },\n\n        /**\n         * Add a track or array of tracks to the visualization.\n         */\n        add_tracks: function(tracks) {\n            this.get(\"drawables\").add(tracks);\n        }\n    },\n    {\n        // This definition matches that produced by to_dict() methods in tracks.js\n        to_json_keys: [\"view\", \"viewport\", \"bookmarks\"],\n\n        to_json_mappers: {\n            view: function(dummy, self) {\n                return {\n                    obj_type: \"View\",\n                    prefs: {\n                        name: self.get(\"title\"),\n                        content_visible: true\n                    },\n                    drawables: self.get(\"drawables\")\n                };\n            }\n        }\n    }\n);\n\n/**\n * -- Routers --\n */\n\n/**\n * Router for track browser.\n */\nvar TrackBrowserRouter = Backbone.Router.extend({\n    initialize: function(options) {\n        this.view = options.view;\n\n        // Can't put regular expression in routes dictionary.\n        // NOTE: parentheses are used to denote parameters returned to callback.\n        this.route(/([\\w]+)$/, \"change_location\");\n        this.route(/([\\w+]+:[\\d,]+-[\\d,]+)$/, \"change_location\");\n\n        // Handle navigate events from view.\n        this.view.on(\"navigate\", new_loc => {\n            this.navigate(new_loc);\n        });\n    },\n\n    change_location: function(new_loc) {\n        this.view.go_to(new_loc);\n    }\n});\n\nexport default {\n    BackboneTrack: BackboneTrack,\n    BrowserBookmark: BrowserBookmark,\n    BrowserBookmarkCollection: BrowserBookmarkCollection,\n    Cache: Cache,\n    CanvasManager: CanvasManager,\n    Genome: Genome,\n    GenomeDataManager: GenomeDataManager,\n    GenomeRegion: GenomeRegion,\n    GenomeRegionCollection: GenomeRegionCollection,\n    GenomeVisualization: GenomeVisualization,\n    GenomeReferenceDataManager: GenomeReferenceDataManager,\n    TrackBrowserRouter: TrackBrowserRouter,\n    Visualization: Visualization,\n    select_datasets: select_datasets\n};\n"]}